<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card payment - Error</title>
        <!--favicon-->
    <link rel="icon" href="/assets/img/ico-fx.png" type="image/x-icon">
    <!-- notifications css -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="https://cardpayment.flexpay.cd/assets/new_design/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="https://cardpayment.flexpay.cd/assets/new_design/jquery-1.11.1.min.js"></script>
    <script src="https://cardpayment.flexpay.cd/assets/new_design/bootstrap.min.js"></script>
    <script src="https://cardpayment.flexpay.cd/assets/new_design/loadingoverlay.js"></script>

    <!------ Include the above in your HEAD tag ---------->
    <link href="https://cardpayment.flexpay.cd/assets/new_design/font-awesome.min.css" rel="stylesheet" id="bootstrap-css">

    <style>
        tr td{ padding: 5px;  font-size: 13px; }
        .sidebar-menu > li > a, .main-sidebar{ background-color: #0c0b0c;!important; }

                .form-error ul {
            list-style-type: none;
            margin: 0!important;
            padding: 0!important;
        }

        .form-error ul li {
            color: #a94442;
        }

        .fade.in {
            opacity: 1;
        }


    </style>
</head>
<body>
<!-- ======= Header ======= -->
    <!-- Content Header (Page header) -->

    <div id="login-overlay" class="modal-dialog" style="margin-bottom: 100px">
        <div class="modal-content">
            <div class="text-center" style="padding: 0px!important;font-size: 0.8em!important;">
                                    <div class="alert alert-warning">Le paramètre reference ne peut pas depasser 25 charactères</div>

            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        <img class="img-thumbnail pull-left" style="border: hidden" width="120" src="/assets/img/logo.png" title="logo" alt="" />
                        <img class="img-thumbnail pull-right" style="border: hidden" width="120" src="/assets/images/flexpay.jpeg" title="FlexPay"  alt=""/>
                    </div>
                </div>
                <div class="row">
                </div>
            </div>
        </div>
    </div>

<div class="text-center" style="padding:7px; color: black; width: 100%; position: fixed; bottom:0px; z-index: 10000;background: #428bca">
    Plateforme sécurisée par <a href="http://flexpay.cd/" style="font-weight : bold;color: white!important;" target="_blank">flexpay</a> <br>
    © 2021 flexpay. Tous droits réservés.
    <br>
    <img src="/assets/images/flexpay.jpeg" height="30">
</div>
            <script src="https://cardpayment.flexpay.cd/assets/vendor/jquery-sticky/jquery.sticky.js"></script>     
        <script type="application/javascript">
            function Redirect(url) {
                window.location = url;
            }

            $(document).ready(function () {


                $('#exampleModal').modal('show');
                $("#payment").submit(function (event) {
                    event.preventDefault();
                    var formData = {
                        authorization: $("#payment_authorization").val(),
                        merchant: $("#payment_merchant").val(),
                        amount: $("#payment_amount").val(),
                        currency: $("#payment_currency").val(),
                        description: $("#payment_description").val(),
                        reference: $("#payment_reference").val(),
                        callback_url: $("#payment_callback_url").val(),
                        approve_url: $("#payment_approve_url").val(),
                        decline_url: $("#payment_decline_url").val(),
                        cancel_url: $("#payment_cancel_url").val(),
                        card: $("#payment_card").val().trim(),
                        cvv: $("#payment_cvv").val(),
                        cardName: $("#payment_cardName").val(),
                        expirationMonth: $("#payment_expirationMonth").val(),
                        expirationYear: $("#payment_expirationYear").val(),
                    };

                    console.log(formData);

                    $.ajax({
                        type: "POST",
                        url: "/confirm-payment",
                        data: formData,
                        encode: true,
                        success: function (data) {
                            console.log('Success...');
                            console.log(data);
                            $.LoadingOverlay("hide");
                            if (!data.success){
                                if (data.errors.card) {
                                    $("#card-number").addClass("has-error");
                                    $("#card-number").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.card + "</div>"
                                    );
                                }

                                if (data.errors.cardName) {
                                    $("#card-name").addClass("has-error");
                                    $("#card-name").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.cardName + "</div>"
                                    );
                                }

                                if (data.errors.expirationMonth) {
                                    $("#card-month").addClass("has-error");
                                    $("#card-month").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.expirationMonth + "</div>"
                                    );
                                }

                                if (data.errors.expirationYear) {
                                    $("#card-year").addClass("has-error");
                                    $("#card-year").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.expirationYear + "</div>"
                                    );
                                }

                                if (data.errors.cvv) {
                                    $("#card-cvv").addClass("has-error");
                                    $("#card-cvv").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.cvv + "</div>"
                                    );
                                }

                                if (data.errors.message) {
                                    $("#card-message").addClass("has-error");
                                    $("#card-message").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.message + "</div>"
                                    );
                                }

                                if (data.errors.authorization) {
                                    $("#card-message").addClass("has-error");
                                    $("#card-message").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.authorization + "</div>"
                                    );
                                }

                                if (data.errors.merchant) {
                                    $("#card-message").addClass("has-error");
                                    $("#card-message").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.merchant + "</div>"
                                    );
                                }

                                if (data.errors.reference) {
                                    $("#card-message").addClass("has-error");
                                    $("#card-message").append(
                                        '<div style="font-size: 0.8em" class="help-block">' + data.errors.reference + "</div>"
                                    );
                                }

                            }else {
                                if (data.code === '0') {
                                                                        window.location = data.url;
                                    //$('#successModal').modal('show');
                                    //setTimeout('Redirect($("#payment_approve_url").val())', 5000);
                                                                        //setTimeout('Redirect(data.url)', 1000);   
                                }else {
                                    $('#declineModal').modal('show');
                                    setTimeout('Redirect($("#payment_decline_url").val())', 5000);
                                }
                            }
                        },
                        beforeSend: function () {
                            $("#card-number").removeClass("has-error");
                            $("#card-name").removeClass("has-error");
                            $("#card-cvv").removeClass("has-error");
                            $("#card-month").removeClass("has-error");
                            $("#card-year").removeClass("has-error");
                            $("#card-message").removeClass("has-error");

                            $(".help-block").remove();

                            console.log('Before send...');
                            $.LoadingOverlay("show");
                        },
                        error: function (data) {
                            console.log('Error...');
                            $.LoadingOverlay("hide");
                        }
                    });
                });

                $("#cancel_payment").on('click', function () {
                    window.location = $("#payment_cancel_url").val();
                })
            })
        </script>

</body>
</html>